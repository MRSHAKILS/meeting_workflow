{% extends "base1.html" %}
{% block title %}Meeting: {{ meeting.name }}{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold">{{ meeting.name }}</h1>
  <p><strong>Bot:</strong> {{ meeting.bot_name }}</p>
  <p><strong>Join Time:</strong> {{ meeting.join_time }}</p>

  <div class="meeting-grid mt-6">
    <!-- Transcript section -->
    <div class="transcript-container">
      <h2 class="text-xl font-semibold mb-2">Transcript</h2>
      <div class="transcript-box">
        {% for seg in segments %}
          <div class="mb-4">
            {% if seg.speaker %}
              <p class="font-semibold text-blue-600">{{ seg.speaker }}:</p>
            {% endif %}
            <p class="mt-1 whitespace-pre-wrap">{{ seg.text }}</p>
            <p class="text-xs text-gray-600 mt-1">{{ seg.created }}</p>
          </div>
        {% empty %}
          <p>No transcript yet.</p>
        {% endfor %}
      </div>

      <form method="POST" action="{% url 'transcribe_meeting' meeting.id %}">
        {% csrf_token %}
        <button type="submit" class="transcribe-btn">
          üìù Generate Transcript
        </button>
      </form>

      <!-- Summarize section -->
      {% with meeting.transcripts.all as t_list %}
        {% if t_list %}
          {% with t_list.0 as first_trans %}
            {% if first_trans.summary %}
              <div class="mt-4 p-4 rounded bg-gray-100">
                <h3 class="font-semibold text-lg">Summary:</h3>
                <p class="mt-2 whitespace-pre-wrap">{{ first_trans.summary }}</p>
              </div>
            {% else %}
              <div class="mt-4">
                <button
                  onclick="summarize({{ first_trans.id }})"
                  class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                >
                  üí° Summarize Transcript
                </button>
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      {% endwith %}
    </div>

    <!-- Screenshots/Slides section -->
    <div class="slides-container">
      <h2 class="text-xl font-semibold mb-2">Slides</h2>
      {% for shot in screenshots %}
        <img src="/{{ shot.image_path }}" alt="Screenshot at {{ shot.created }}">
      {% empty %}
        <p>No screenshots yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<script>
function summarize(id) {
  fetch("{% url 'summarize_transcript' 0 %}".replace('/0/', `/${id}/`), {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Accept": "application/json"
    }
  })
  .then(res => {
    if (!res.ok) {
      return res.text().then(text => { throw new Error(text); });
    }
    return res.json();
  })
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert("Summarization failed: " + data.error);
    }
  })
  .catch(err => {
    console.error("Error:", err);
    alert("Network error: " + err.message);
  });
}
</script>
{% endblock %}
